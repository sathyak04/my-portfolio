<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capybara Run!</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #f0f0f0;
        }
        canvas {
            display: block;
            margin: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* keeps correct aspect ratio */
        }
    </style>
</head>
<body>
    <script src="https://unpkg.com/kaplay/dist/kaplay.js"></script>
    <script>
        kaplay({
            background: [255, 255, 255],
            debug: false,
            width: 1280,   // base design width
            height: 720,   // base design height
            scale: 1,
            stretch: false,   // prevent weird zoom/stretch
            letterbox: true,  // keep everything visible
        })

        loadSprite("capybara", "capybara.png")
        loadSprite("orange", "orange.png")
        loadSprite("triple_orange", "triple_orange.png")
        loadSprite("logo", "logo.png")
        loadFont("pixel_font", "../pixel.ttf")

        scene("menu", () => {
            // Background
            function spawnBackground() {
                add([
                    circle(rand(100, 400)),
                    opacity(.5),
                    z(-10),
                    pos(width() + 200, rand(0, height())),
                    scale(rand(.3, .5)),
                    move(LEFT, 200),
                    offscreen({destroy: true}),
                    color(255, 165, 0)
                ])
            }
            loop(1.5, () => spawnBackground())

            // Logo
            add([
                sprite("logo"),
                scale(.3),
                pos(width() / 2, height() * 0.20),
                anchor("center")
            ])

            // Instructions
            add([
                text("CLICK TO PLAY!", {
                    font: "pixel_font",
                    size: 100
                }),
                pos(width() / 2, height() * 0.9),
                anchor("center"),
                color(255, 165, 0),
            ])

            // Blinking Box
            const blinkingBox = add([
                pos(width() / 2, height() * 0.89),
                anchor("center"),
            ])

            blinkingBox.add([
                rect(548, 4),
                pos(-274, -50),
                color(255, 165, 0),
            ])
            blinkingBox.add([
                rect(551.6, 4),
                pos(-274, 50),
                color(255, 165, 0),
            ])
            blinkingBox.add([
                rect(4, 100),
                pos(-274, -50),
                color(255, 165, 0),
            ])
            blinkingBox.add([
                rect(4, 100),
                pos(274, -50),
                color(255, 165, 0),
            ])

            let timer = 0
            onUpdate(() => {
                timer += dt()
                if (timer >= 0.5) {
                    blinkingBox.hidden = !blinkingBox.hidden
                    timer = 0
                }
            })

            // Logo details
            add([
                sprite("triple_orange"),
                scale(.5),
                pos(width() * 0.75, height() * 0.35),
                anchor("center")
            ])
            add([
                sprite("capybara"),
                scale(.9),
                pos(width() * 0.27, height() * 0.35),
                anchor("center")
            ])

            // Controls header
            add([
                text("CONTROLS", {
                    font: "pixel_font",
                    size: 80
                }),
                pos(width() / 2, height() * 0.45),
                anchor("center"),
                color(255, 165, 0),
            ])
            add([
                rect(215, 10),
                pos(width() / 2, height() * 0.5),
                anchor("center"),
                color(255, 165, 0),
            ])

            // Controls buttons
            const buttonY = height() * 0.6
            add([
                rect(100, 100, { color: rgb(255, 255, 255) }),
                outline(4, rgb(255, 165, 0)),
                pos(width() * 0.28, buttonY),
                anchor("center")
            ])
            add([
                rect(100, 100, { color: rgb(255, 255, 255) }),
                outline(4, rgb(255, 165, 0)),
                pos(width() * 0.41, buttonY),
                anchor("center")
            ])
            add([
                rect(340, 100, { color: rgb(255, 255, 255) }),
                outline(4, rgb(255, 165, 0)),
                pos(width() * 0.63, buttonY),
                anchor("center")
            ])

            // Labels
            add([
                text("A", { font: "pixel_font", size: 80 }),
                pos(width() * 0.28, buttonY),
                anchor("center"),
                color(255, 165, 0),
            ])
            add([
                text("LEFT", { font: "pixel_font", size: 60 }),
                pos(width() * 0.28, buttonY + 85),
                anchor("center"),
                color(0, 0, 0),
            ])
            add([
                text("D", { font: "pixel_font", size: 80 }),
                pos(width() * 0.41, buttonY),
                anchor("center"),
                color(255, 165, 0),
            ])
            add([
                text("RIGHT", { font: "pixel_font", size: 60 }),
                pos(width() * 0.41, buttonY + 85),
                anchor("center"),
                color(0, 0, 0),
            ])
            add([
                text("SPACEBAR", { font: "pixel_font", size: 80 }),
                pos(width() * 0.63, buttonY),
                anchor("center"),
                color(255, 165, 0),
            ])
            add([
                text("JUMP", { font: "pixel_font", size: 60 }),
                pos(width() * 0.63, buttonY + 85),
                anchor("center"),
                color(0, 0, 0),
            ])

            onClick(() => go("game"))
        })

        scene("game", () => { 
            // Background
            function spawnBackground() {
                add([
                    circle(rand(100, 400)),
                    opacity(.5),
                    z(-10),
                    pos(width() + 200, rand(0, height())),
                    scale(rand(.3, .5)),
                    move(LEFT, 200),
                    offscreen({destroy: true}),
                    color(255, 165, 0)
                ])
            }
            loop(1.5, () => spawnBackground())

            setGravity(950)

            // Obstacles
            function spawnObstacles() {
                add([
                    rect(50, 1000),
                    pos(width(), rand(height() * 0.65, height() * 0.75)),
                    area(),
                    "obstacle",
                    move(LEFT, 200),
                    offscreen({destroy: true}),
                    color(255, 165, 0)
                ])
            }
            loop(rand(2, 3.5), () => spawnObstacles())

            // Floor
            add([
                rect(width(), height() * 0.2),
                pos(0, height() * 0.9),
                area(),
                body({ isStatic: true }),
                color(255, 165, 0),
            ])

            // Player
            let player = add([
                sprite("capybara"),
                pos(width() * 0.05, height() * 0.7),
                area({width: 0, height: 0}),
                scale(.4),
                "player",
                { speed: 300 },
                body(),
            ])

            // Food
            function spawnOrange() {
                add([
                    sprite("orange"),
                    pos(width(), height() * 0.82),
                    scale(.2),
                    "food",
                    area(),
                    move(LEFT, 200),
                    offscreen({destroy: true}),
                ])
            }
            loop(rand(3, 5), () => spawnOrange())

            // Score
            let score = 0
            const scoreText = add([
                text("Score: " + score, {
                    font: "pixel_font",
                    size: 40
                }),
                z(100),
                pos(width() / 2, height() * 0.05),
                anchor("center"),
                color(0, 0, 0)
            ])

            // Collisions
            onCollide("player", "food", (player, food) => {
                destroy(food)
                score += 10
                scoreText.text = "Score: " + score
                burp()
            })

            loadSound("bang", "bang.mp3")
            onCollide("player", "obstacle", (player, food) => {
                play("bang")
                addKaboom(player.pos)
                destroy(player)
                player.speed = 0
                score = 0
                add([
                    text("GAME OVER", {
                        font: "pixel_font",
                        size: 60
                    }),
                    pos(width() / 2, height() / 2),
                    anchor("center"),
                    color(255, 165, 0),
                ])
                wait(3, () => go("menu"))
            })

            onCollide("food", "obstacle", (food, obstacle) => {
                destroy(food)
            })

            // Controls
            loadSound("jump", "jump.mp3")
            onKeyPress("space", () => {
                if (player.isGrounded()) {
                    play("jump")
                    player.jump()
                }
            })
            onUpdate(() => {
                player.pos.x = clamp(player.pos.x, 0, width() - 80)
            })
            onKeyDown("a", () => player.move(-player.speed, 0))
            onKeyDown("d", () => player.move(player.speed, 0))
        })

        go("menu")
    </script>
</body>
</html>